---
import { languages } from '../i18n/ui';
const { pathname } = Astro.url;

// @ts-ignore
const getTargetUrl = (lang: string) => {
  const path = pathname.startsWith('/en') ? pathname.replace('/en', '') : pathname;
  const cleanPath = path === '' ? '/' : path;
  return lang === 'en' ? `/en${cleanPath}` : cleanPath;
};
---

<div class="flex gap-2 p-2">
  {Object.entries(languages).map(([lang, label]) => (
    <a
      href={getTargetUrl(lang)}
      class={`px-3 py-1 rounded-md text-sm font-medium transition-colors lang-link ${
        (pathname.startsWith('/en') ? 'en' : 'es') === lang
          ? 'bg-white/20 text-white border border-white/50'
          : 'text-white/70 hover:text-white hover:bg-white/10'
      }`}
    >
      {label}
    </a>
  ))}
</div>

<script is:inline>
  document.addEventListener('click', (e) => {
    const link = e.target.closest('.lang-link');
    if (link) {
      const currentHash = window.location.hash;
      if (currentHash) {
        // Marcamos que estamos haciendo un cambio de idioma con hash
        sessionStorage.setItem('language-switching', 'true');
        link.href = link.getAttribute('href') + currentHash;
      }
    }
  });

  // Este bloque se ejecuta apenas carga la página nueva
  if (sessionStorage.getItem('language-switching') === 'true') {
    // 1. Desactivamos el scroll suave temporalmente
    document.documentElement.style.scrollBehavior = 'auto';
    
    // 2. Forzamos el salto al hash si existe
    if (window.location.hash) {
      const id = window.location.hash.substring(1);
      const el = document.getElementById(id);
      if (el) el.scrollIntoView();
    }

    // 3. Limpiamos y devolvemos el scroll suave después de un pequeño frame
    sessionStorage.removeItem('language-switching');
    setTimeout(() => {
      document.documentElement.style.scrollBehavior = 'smooth';
    }, 100);
  }
</script>